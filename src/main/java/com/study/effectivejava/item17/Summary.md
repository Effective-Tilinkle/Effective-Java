# 변경가능성을 최소화하라

- 자바 플랫폼에 다양한 불변 클래스 String, BigInteger, BigDecimal
- 불변객체는 생명주기동안 그 상태가 변하지 않는 객체를 의미

### 불변 클래스를 만들기 위한 규칙
1. 객체의 상태를 변경하는 메서드를 제공X
2. 클래스 확장 불가능하도록 (클래스를 final로 선언)
   1. 혹은 모든 생성자를 private / default로 만들고 정적 팩터리 메서드 제공
3. 모든 필드를 final로 선언
4. 모든 필드를 private으로 선언
5. 자신 외에는 내부의 가변 컴포넌트에 접근할 수 업도록 한다.
   - 생성자, 접근자, readObject메서드 모두에서 방어적 복사를 수행하라
   - 방어적 복사 : 반환 시, 복사본을 만들어 반환
   - 컬렉션인 경우 Unmodifiable Collection

    
### Complex인스턴스 사칙연산 메서드 예제
- 인스턴스 자신은 수정하지 않고, 새로운 Complex인스턴스를 반환
- 이처럼 피연산자에 함수를 적용해 그 결과를 반환하지만, 피연산자 자체는 그대로인 프로그래밍 패턴을 **함수형 프로그래밍**이라 한다.
- 해당 예제의 주목할 점 : 메서드 이름을 add같은 동사 대신, plus같은 **전치사를** 사용함
  - **이는 메서드가 객체의 값을 변경하지 않는다는 사실을 강조하려는 의도**

### 불변객체 장점
1. 스레드 안전, 동기화 필요 없음
2. 안심하고 공유가능 - 최대한 재활용
   1. 이는 방어적 복사도 필요 없다는 내용과 이어짐
3. 불변객체끼리는 내부 데이터 공유 가능
4. 그 자체로 실패 원자성 제공 - 예외 발생해도 여전히 유효한 상태다

### 단점
1. 값이 다르면 반드시 독립된 객체로 만들어야 함
   - 불필요한 메모리 낭비가 있을 수 있다
   - 대처 방법1 : 흔히 쓰이는 다단계연산을 예측하여 기본 기능으로 제공
     - ex) BigInteger 가변동반클래스를 default로 두고 있음
   - 대처 방법2 : 예측 불가능하면, 해당 클래스를 public으로 제공
     - ex) String의 public한 가변동반 클래스는 StringBuilder / StringBuffer

### 불변클래스의 모든필드가 final이고 어떤 메서드도 그 객체를 수정할 수 없어야 한다는 너무 엄격
- 조금 완화해서 '어떤 메서드도 객체의 상태 중 외부에 비치는 값을 변경할 수 없다'


## 직렬화 시 주의점
- Serializable을 구현하는 불변 클래스의 내부에 가변 객체를 참조하는 필드가 있다면, readObject, readResolve 메서드를 반드시 제공하거나,
ObjectOutputStream.writeUnshared와 ObjectInputStream.readUnshared메서드를 사용해야 한다.


- 클래스는 꼭 필요한 경우가 아니라면 불변이어야 한다
- 불변으로 만들 수 없는 클래스라도 변경할 수 있는 부분을 최소한으로 줄이자
- 다른 합당한 이유가 없다면 모든 필드는 private final이어야 한다.
- 생성자는 불변식 설정이 모두 완료된, 초기화가 완벽히 끝난 상태의 객체를 생성해야 한다.